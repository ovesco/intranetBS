<!-- on stocke les infos du propriétaire pour les récupérer -->
<input type="hidden" value="{{ ownerEntity.id }}" id="owner-entity-id"/>

{% if ownerEntity.isClass('Membre') %}
    <input type="hidden" value="Membre" id="owner-entity-type"/>
{% elseif ownerEntity.isClass('Famille') %}
    <input type="hidden" value="Famille" id="owner-entity-type"/>
{% endif %}


<div id="finances-infos-context" class="tab-context">

    <div class="ui top attached tabular menu">
        <div class="item active" data-tab="finances">
            Infos
        </div>
        <div class="item" data-tab="factures">
            Factures
            <div class="ui teal circular label">{{ ownerEntity.factures|length }}</div>
        </div>
        <div class="item" data-tab="creances">
            Creances
            <div class="ui teal circular label">{{ ownerEntity.creances|length }}</div>
        </div>

    </div>
    <div class="ui bottom attached active tab segment" data-tab="finances">
        <div class="ui grid" id="infoFinanceContent">
            <div class="row">
                <div class="column">
                    {% if ownerEntity.isClass('Membre') %}

                        Les cérances de ce membre sont facturée

                        {% if ownerEntity.envoiFacture == 'Membre' %}
                            à lui même.
                        {% elseif ownerEntity.envoiFacture == 'Famille' %}
                            à la famille {{ ownerEntity.famille.nom }}
                        {% endif %}

                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="ui bottom attached tab segment" data-tab="factures">
        <div class="ui grid" id="listeFactureContent">
            <div class="row">
                <div class="column">
                    <table class="ui table" id="listeFacturesTable">
                    <thead>
                    <tr>
                        <th rowspan="2">Num. Réf.</th>
                        <th rowspan="2">Statut</th>

                        <th colspan="4">Montants</th>
                        <th>Actions</th>

                    </tr>
                    <tr>
                        <th>Créances</th>
                        <th>Rappels</th>
                        <th>Total</th>
                        <th>Reçu</th>
                        <th></th>

                    </tr>
                    </thead>

                    <tbody>
                    {% if ownerEntity.factures is not empty %}
                        {% for facture in ownerEntity.factures %}
                            <tr>
                                <td>N°{{ facture.id }}</td>
                                {% if facture.statut == 'ouverte' %}
                                    <td><div class="ui blue label">Ouverte</div></td>
                                {% elseif facture.statut == 'payee' %}
                                    <td><div class="ui green label">Payée</div></td>
                                {% else %}
                                    <td></td>
                                {% endif %}
                                <td>{{ facture.montantEmisCreances|number_format(2, '.', ',') }}</td>
                                <td>{{ facture.montantEmisRappels|number_format(2, '.', ',') }}</td>
                                <td>{{ facture.montantEmis|number_format(2, '.', ',') }}</td>
                                <td>{{ facture.montantRecu|number_format(2, '.', ',') }}</td>
                                <td>


                                    {% if facture.statut == 'ouverte' %}
                                        <a class="popupable"
                                           onclick="openRappelForm({{ facture.id }},'interface');"
                                           data-content="Ajouter un rappel">
                                            <i class="add square icon"></i>
                                        </a>
                                    {% endif %}



                                    <a onclick="printFacture(this);" data-id="{{ facture.id }}" target="_blank">
                                        <i class="print icon"></i>
                                    </a>

                                    <a onclick="openFactureShow({{ facture.id }},'interface');" >
                                        <i class="zoom icon"></i>
                                    </a>


                                    <a onclick="deleteFactureFromInterface(this);"
                                       data-id="{{ facture.id }}"
                                       >
                                        <i class="trash icon red"></i>
                                    </a>




                                </td>

                            </tr>
                        {% endfor %}
                    {% else %}

                    {% endif %}
                    </tbody>
                </table>
                </div>
            </div>
        </div>
    </div>
    <div class="ui bottom attached tab segment" data-tab="creances">
        <div class="ui grid" id="listeCreanceContent">
    <div class="row" >
        <div class="column">
            <div class="ui right floated basic segment">

                    {% if ownerEntity.isClass('Membre') %}
                        <div class="ui button" onclick="openCreancelForm({{ ownerEntity.id }},'Membre','interfaceMembre')">Ajouter une créance</div>
                    {% elseif ownerEntity.isClass('Famille') %}
                        <div class="ui button" onclick="openCreancelForm({{ ownerEntity.id }},'Famille','interfaceFamille')">Ajouter une créance</div>
                    {% endif %}

                    <div class="ui button" onclick="createFactureFromInterface();">Facturer les créances séléctionnées</div>

                </div>
            <table class="ui table" id="listeCreanceTable">

                    <thead>
                    <tr>
                        <th rowspan="2">
                            <input type="checkbox" onclick="selectAllCreances(this);">
                        </th>
                        <th colspan="2">Factures liée</th>
                        <th rowspan="2">Titre</th>
                        <th rowspan="2">Remarque</th>
                        <th colspan="2">Montants</th>
                        <th rowspan="2" >Actions</th>
                    </tr>
                    <tr>

                        <th>N° Réf.</th>
                        <th>Statut</th>
                        <th>Emis</th>
                        <th>Reçu</th>



                    </tr>
                    </thead>

                    <tbody>
                    {% if ownerEntity.creances is not empty %}

                        {# On commence par les creances non facturée #}
                        {% for creance in ownerEntity.creances|reverse  %}
                            {% if creance.facture is empty %}
                                <tr>
                                    <td>
                                        <input class="selectCreance" type="checkbox" value="{{ creance.id }}">
                                    </td>
                                    <td></td>
                                    <td><div class="ui orange label">En attente</div></td>
                                    <td>{{ creance.titre }}</td>
                                    <td>{{ creance.remarque }}</td>
                                    <td>{{ creance.montantEmis|number_format(2, '.', ',') }}</td>
                                    <td>{{ creance.montantRecu|number_format(2, '.', ',') }}</td>
                                    <td>

                                        <a onclick="deleteCreanceFromInterface(this);"
                                           data-id="{{ creance.id }}"
                                           >
                                            <i class="trash icon red"></i>
                                        </a>

                                        <a onclick="openCreanceShow({{ creance.id }});" >
                                            <i class="zoom icon"></i>
                                        </a>



                                    </td>
                                </tr>
                            {% endif %}

                        {% endfor %}

                        {# Créance avec facture ouverte #}
                        {% for creance in ownerEntity.creances|reverse  %}
                            {% if creance.facture is not empty %}
                                {% if creance.facture.statut == 'ouverte' %}
                                    <tr>
                                        <td></td>
                                        <td>N°{{ creance.facture.id }}</td>
                                        <td><div class="ui blue label">Ouverte</div></td>
                                        <td>{{ creance.titre }}</td>
                                        <td>{{ creance.remarque }}</td>
                                        <td>{{ creance.montantEmis|number_format(2, '.', ',') }}</td>
                                        <td>{{ creance.montantRecu|number_format(2, '.', ',') }}</td>
                                        <td>
                                            <a onclick="openCreanceShow({{ creance.id }});" >
                                                <i class="zoom icon"></i>
                                            </a>
                                        </td>

                                    </tr>
                                {% endif %}
                            {% endif %}

                        {% endfor %}

                        {# Créance avec facture payée #}
                        {% for creance in ownerEntity.creances|reverse  %}
                            {% if creance.facture is not empty %}
                                {% if creance.facture.statut == 'payee' %}
                                    <tr>
                                        <td></td>
                                        <td>N°{{ creance.facture.id }}</td>
                                        <td><div class="ui green label">Payée</div></td>
                                        <td>{{ creance.titre }}</td>
                                        <td>{{ creance.remarque }}</td>
                                        <td>{{ creance.montantEmis|number_format(2, '.', ',') }}</td>
                                        <td>{{ creance.montantRecu|number_format(2, '.', ',') }}</td>
                                        <td>
                                            <a onclick="openCreanceShow({{ creance.id }});" >
                                                <i class="zoom icon"></i>
                                            </a>
                                        </td>

                                    </tr>
                                {% endif %}
                            {% endif %}

                        {% endfor %}

                    {% else %}

                    {% endif %}

                    </tbody>

                </table>
        </div>
    </div>
</div>
    </div>
</div>


{% include "InterneFinancesBundle:Modal:modalDisplay.html.twig" %}



{% block javascript %}

    {% javascripts
    '@InterneFinancesBundle/Resources/public/js/creance.js'
    '@InterneFinancesBundle/Resources/public/js/facture.js'
    '@InterneFinancesBundle/Resources/public/js/interfaceMembreFamille.js'
    '@InterneFinancesBundle/Resources/public/js/rappel.js'%}
    <script src="{{ asset_url }}"></script>

    {% endjavascripts %}


{% endblock %}



